<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Waveform Drawer</title>
    <style>label,
    textarea{
        display:inline-block;
        vertical-align:middle;

    }</style>
</head>
<body ng-app="waveform">
<h1 style="text-align: center">Waveform Drawer Example</h1>
<div ng-controller="Controller">
<label for="textarea"><h3>JSON:</h3></label>
<textarea id="textarea" ng-model="json" cols="40" rows="5">
</textarea>
    <hr/>
    <div style="position: relative; width: 100%; height: 240px;" mirrored waveform="json"></div>
</div>
<script src="//code.angularjs.org/snapshot/angular.min.js"></script>
<script type="application/javascript">
    (function(angular) {
        'use strict';
        angular.module('waveform', [])
            .controller('Controller', ['$scope', ($scope) => {
                $scope.json = `{
    "width":1800,
    "height":140,
    "samples": [
14,15,15,15,15,14,14,15,15,15,15,15,15,14,15,15,14,15,15,
15,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,
15,15,15,15,15,15,133,110,96,85,77,126,117,112,104,108,
102,107,113,109,100,93,93,121,109,104,103,99,101,106,
115,108,108,108,125,122,108,114,115,115,109,112,114,
109,109,108,106,105,100,97,96,98,126,127,108,107,114,
117,114,102,98,94,94,94,99,95,98,94,93,93,90,90,94,95,
98,96,101,118,114,111,110,131,129,104,110,109,113,107,
111,110,113,111,104,101,87,90,89,87,91,115,119,114,112,
110,120,108,95,90,93,87,87,92,90,90,91,93,124,129,122,
116,112,107,107,117,103,98,101,103,128,113,110,105,110,
108,113,102,110,104,102,111,99,97,95,89,87,87,90,137,
104,114,104,121,107,95,83,81,74,80,111,104,103,102,106,
101,103,72,69,62,71,89,87,98,95,84,82,139,102,108,120,
118,104,109,113,111,114,108,109,101,99,99,96,96,96,99,
131,125,109,115,108,121,111,105,105,104,106,99,117,109,
103,107,111,120,98,99,94,94,94,93,90,86,88,92,88,131,
119,107,110,119,118,110,110,106,106,111,112,106,105,97,93,
95,88,92,118,107,111,115,108,118,107,96,88,82,83,94,95,
93,97,98,95,89,86,81,76,75,69,76,108,116,117,115,117,129,
123,108,113,116,105,108,110,103,102,110,114,102,106,100,
92,98,100,95,125,115,105,118,109,124,107,97,95,100,97,
95,102,104,98,97,101,127,123,117,114,111,104,107,118,103,
99,96,99,127,117,112,97,111,99,106,107,112,112,111,111,
94,99,99,100,102,93,94,128,114,109,119,116,121,105,93,91,
84,86,95,114,109,107,105,103,100,101,71,70,66,64,60,61,
100,90,84,85,137,99,112,111,119,111,109,112,108,110,111,
109,97,100,85,65,66,71,81,126,125,103,114,106,122,108,
105,106,103,104,94,109,110,106,108,104,122,97,99,88,84,
88,85,84,82,78,83,90,138,119,111,109,108,110,112,107,106,
107,111,110,106,107,97,98,99,97,95,121,115,108,106,112,
121,108,97,95,90,91,89,93,94,94,93,93,93,92,97,96,97,92,
91,99,110,110,113,112,133,115,109,110,103,112,104,101,101,
102,102,102,93,90,87,84,86,90,100,127,111,111,107,109,
117,106,93,88,91,88,107,110,113,109,105,101,122,109,99,96,
95,95,94,94,93,94,93,94,128,113,115,115,111,118,115,
117,105,114,110,107,103,101,91,88,85,84,96,131,116,105,
111,113,116,102,89,80,77,70,85,106,106,106,106,104,93,94,
83,69,70,65,64,76,102,95,90,85,134,112,117,120,113,111,
102,106,97,115,99,103,99,94,99,99,97,98,105,127,121,111,
110,113,121,110,107,107,106,105,99,101,105,111,103,114,
115,101,101,97,90,92,91,92,95,94,93,92,139,116,118,114,
105,115,109,111,110,107,107,108,100,100,87,91,95,92,92,
110,116,115,109,114,118,107,98,97,104,90,97,89,86,80,82,
89,91,96,95,91,99,101,92,110,114,115,117,114,132,119,115,
109,115,106,113,114,104,103,104,115,103,104,98,101,95,
98,124,116,112,119,101,109,114,103,99,94,94,100,101,93,
102,104,101,97,127,115,110,106,106,116,101,116,113,112,
106,106,129,110,107,105,107,107,107,113,111,105,101,103,
104,98,97,94,100,102,93,117,115,112,123,116,115,102,93,
89,87,89,89,113,102,107,108,108,101,91,69,69,66,67,61,
93,96,89,83,94,123,102,122,104,114,113,114,111,108,109,
107,111,101,99,79,76,78,90,106,108,113,114,114,120,127,
111,111,105,107,103,100,104,106,99,109,105,129,115,116,
108,111,108,108,105,106,105,103,103,120,116,112,112,124,
118,104,113,118,113,101,118,118,103,114,122,110,117,118,
121,115,108,105,121,119,107,115,117,101,113,118,101,115,
111,104,113,109,109,112,107,113,116,109,112,112,108,116,
116,126,111,105,104,95,102,102,100,84,84,86,103,118,114,
113,123,110,118,118,126,108,110,121,116,114,104,106,109,
106,106,101,117,113,114,114,113,117,113,113,102,98,86,89,
115,110,111,112,120,130,110,98,97,102,101,101,99,89,95,
94,99,104,109,108,100,96,104,109,122,115,123,124,121,116,
110,109,114,111,108,115,108,108,105,103,106,122,109,115,
109,113,117,105,101,95,94,99,111,134,116,112,108,102,106,
112,112,111,111,106,100,114,110,115,117,115,115,116,122,
101,109,116,116,116,112,112,109,105,106,116,115,112,111,
107,114,119,122,113,104,111,110,98,92,86,86,82,101,121,
113,110,110,112,118,113,109,106,107,104,108,112,110,109,
105,106,108,107,105,104,104,103,121,114,113,111,
112,110,108,105,98,100,104,102,104,103,102,107,103,107,
13,114,109,113,112,108,111,126,106,99,101,98,97,97,94,
102,104,100,96,122,110,110,110,119,111,128,110,115,112,
123,123,112,107,103,112,106,104,102,114,115,113,111,119,
121,117,118,103,96,88,101,111,109,111,109,128,121,110,98,
102,95,102,98,94,97,96,99,103,107,104,103,100,98,101,
115,116,115,117,113,118,118,108,110,104,103,110,106,108,
106,109,106,100,121,115,110,111,108,110,113,105,94,105,
95,121,120,112,114,114,107,110,112,112,112,106,111,108,
112,110,117,114,114,113,124,125,111,107,105,126,113,109,
110,111,108,114,117,117,109,116,104,120,114,115,111,105,
107,111,104,103,100,97,94,115,115,127,104,114,119,123,
113,110,113,112,109,114,121,116,109,114,112,113,110,110,
112,116,115,125,116,115,112,113,113,115,111,110,110,106,
106,112,109,108,105,112,113,120,112,111,118,115,105,128,
114,103,102,101,96,100,100,96,104,104,97,93,116,113,115,
113,116,113,138,119,109,112,120,126,111,110,100,110,107,
102,106,113,113,115,112,130,117,113,111,102,91,91,108,
113,106,109,111,129,112,102,107,101,102,100,95,91,95,96,
95,102,102,100,99,103,105,106,118,127,109,115,122,119,
113,109,106,110,113,107,113,104,112,107,109,95,119,108,
112,115,111,112,114,104,96,99,94,131,118,108,122,111,111,
99,113,112,99,109,110,105,115,111,108,111,113,114,116,
125,114,115,101,117,115,106,104,105,113,108,114,108,108,
108,110,126,115,115,119,109,109,103,104,94,87,83,80,129,
121,116,107,106,114,107,103,112,105,105,102,108,107,102,
104,104,107,104,101,103,102,105,102,126,115,111,106,106,
108,107,110,97,100,104,107,104,104,104,103,99,104,112,
112,108,104,103,100,134,111,104,101,96,104,105,102,100,
97,87,80,96,116,112,113,112,113,108,140,121,110,113,110,
123,113,116,116,110,108,104,113,115,113,113,108,127,111,
108,102,101,97,103,109,107,112,109,108,131,103,106,104,
112,102,103,103,106,101,100,101,104,104,101,102,96,98,
103,130,117,117,110,118,119,114,113,114,104,109,107,107,
104,102,105,106,101,115,112,112,114,108,103,108,102,86,
87,84,132,115,109,113,114,108,106,107,107,109,109,108,97,
109,111,115,112,112,114,112,117,116,113,91,103,116,113,
108,108,109,89,115,109,110,111,110,116,110,113,110,108,
108,102,98,91,80,76,75,68,65,67,64,64,64,64,62,63,62,65,
85,91,101,105,107,105,99,89,121,103,90,82,76,118,104,94,
85,80,72,67,131,117,97,103,93,120,106,94,87,80,72,68,123,
109,93,87,103,129,121,118,113,107,110,104,106,109,107,
104,108,107,108,108,107,107,105,105,108,106,107,108,107,
108,109,106,108,107,104,103,104,98,101,104,106,103,105,
109,98,100,107,105,97,103,111,98,97,92,75,71,69,69,70,70,
69,69,69,68,68,68,68,68,67,69,66,65,66,65,64,65,64,64,
65,64,62,63,62,61,60,60,60,60,60,59,60,60,58,57,56,57,
57,58,56,56,55,54,54,55,54,54,55,53,53,53,52,52,53,53,52,
52,53,52,50,50,50,51,51,50,51,50,50,50,50,50,48,47,48,47,
47,46,46,45,47,46,45,46,46,45,45,45,45,44,44,40,9,0,0
    ]
}`
            }]).directive('waveform', ['$document', '$window', ($document, $window) => {
            const fillStyle = 'rgba(34,56,78,0.7)',
                pixelRatio = window.devicePixelRatio || 1,
                step = 3
            return (scope, element, attrs) => {
                const init = () => {
                        if (null === canvas) {
                            canvas = $document[0].createElement('canvas')
                            canvas.toBlob = canvas.toBlob || canvas.msToBlob
                            ctx = canvas.getContext('2d')
                            img = $document[0].createElement('img')
                            $img = angular.element(img).css({
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                width: '100%',
                                height: '100%',
                                display: 'none'
                            })
                            canvas.toBlob && (img.onload = () => {
                                    URL.revokeObjectURL(img.src)
                                }
                            )
                            element.append(img)
                            resize()
                            angular.element($window).on('resize', throttledDraw)
                            element.on('$destroy', () => {
                                angular.element($window).off('resize', throttledDraw)
                            })
                        }
                    },
                    throttle = (func, delay) => {
                        if (timeout) {
                            $window.clearTimeout(timeout);
                        }
                        timeout = $window.setTimeout(func, delay)
                    },
                    resize = () => {
                        destHeight = element[0].offsetHeight * pixelRatio,
                            destWidth = element[0].offsetWidth * pixelRatio,
                        (destHeight !== prevHeight || destWidth !== prevWidth) && (
                            canvas.width = destWidth, canvas.height = destHeight
                        )
                    },
                    draw = () => {
                        if (data) {
                            init()
                            let X, y, x
                            if (
                                resize(),
                                data !== prevData || destWidth !== prevWidth || destHeight !== prevHeight
                            ) {
                                if (
                                    prevData = data,
                                        prevWidth = destWidth,
                                        prevHeight = destHeight,
                                        ctx.clearRect(0, 0, destWidth, destHeight),
                                        ctx.fillStyle = fillStyle,
                                        ctx.beginPath(),
                                        isMirrored
                                ) {
                                    for (
                                        ctx.moveTo(0, Math.ceil(destHeight / 2)),
                                            X = 0; destWidth >= X; X += step
                                    ) {
                                        for (y = 0, x = X; X + step > x; x++)
                                            y += data[Math.floor(width * (x - x % Math.floor(pixelRatio)) / destWidth)]
                                        y /= step,
                                            ctx.lineTo(X, Math.ceil(destHeight * (1 - y) / 2))
                                    }
                                    for (
                                        ctx.lineTo(destWidth, Math.ceil(destHeight * (1 - data[width - 1]) / 2)),
                                            X = destWidth; X >= 0; X -= step
                                    ) {
                                        for (y = 0, x = X; x > X - step; x--)
                                            y += data[Math.floor(width * (x - x % Math.floor(pixelRatio)) / destWidth)]
                                        y /= step,
                                            ctx.lineTo(X, Math.ceil(destHeight * (1 + y) / 2))
                                    }
                                    ctx.lineTo(0, Math.ceil(destHeight * (1 + data[0]) / 2)),
                                        ctx.lineTo(0, Math.ceil(destHeight / 2))
                                } else {
                                    for (
                                        ctx.moveTo(0, destHeight),
                                            X = 0; destWidth >= X; X += step
                                    ) {
                                        for (y = 0, x = X; X + step > x; x++)
                                            y += data[Math.floor(width * (x - x % Math.floor(pixelRatio)) / destWidth)]
                                        y /= step,
                                            ctx.lineTo(X, Math.ceil(destHeight * (1 - y)))
                                    }
                                    ctx.lineTo(destWidth, destHeight)
                                }
                                if (
                                    ctx.fill(),
                                        canvas.toBlob
                                ) {
                                    let blob = canvas.toBlob((e) => {
                                        img.src = URL.createObjectURL(e),
                                            $img.css('display', 'block')
                                    })
                                    blob && (
                                        img.src = URL.createObjectURL(blob),
                                            $img.css('display', 'block')
                                    )
                                } else
                                    img.src = canvas.toDataURL('image/png'),
                                        $img.css('display', 'block')
                            }
                        }
                    }
                let data = null,
                    timeout = null,
                    width = null,
                    isMirrored = 'mirrored' in attrs,
                    throttledDraw = throttle(draw, 500),
                    prevData = null,
                    prevWidth = null,
                    prevHeight = null
                let ctx, destWidth,
                    destHeight, img, $img, canvas = null, json;
                scope.$watch(attrs.waveform, (value) => {
                    try {
                        json = value && JSON.parse(value)
                    } catch (e) {
                        return
                    }
                    json && json.width && (
                        width = json.width,
                            data = json.samples.map((item) => item / json.height),
                            draw()
                    )
                });
            }
        }])

    })(window.angular);
</script>
</body>
</html>